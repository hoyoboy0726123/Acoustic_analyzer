# 聲學分析校準偏移說明

## 概述

本系統提供兩個校準偏移參數，用於將軟體計算的**相對數值**轉換為**絕對聲壓級 (dB SPL)**，以便與專業聲學測量設備（如 HEAD acoustics ArtemiS SUITE）進行比較和驗證。

---

## 1. 麥克風校準偏移 (Calibration Offset)

### 學理基礎

**標準依據**: IEC 61672-1 (聲級計標準)、IEC 61094 (麥克風校準標準)

當使用數位錄音設備記錄音訊時，錄製的數位訊號是**相對值**（0 到 1 的浮點數或 16-bit 整數）。要將此數位訊號轉換為**絕對聲壓級 dB SPL**，需要知道錄音系統的**靈敏度 (Sensitivity)** 和**增益 (Gain)**。

### 公式推導

```
L_spl = 20 × log₁₀(p / p₀)

其中:
- L_spl: 聲壓級 (dB SPL)
- p: 聲壓 (Pa)
- p₀: 參考聲壓 = 20 μPa (人耳聽覺閾值)
```

對於未校準的數位錄音：
```
L_relative = 20 × log₁₀(x / x_ref)

其中:
- x: 數位訊號值
- x_ref: 參考值（通常為 1.0 或 32768）
```

**校準關係**:
```
L_spl = L_relative + Calibration_Offset
```

### 如何確定校準偏移值

#### 方法 1: 使用校準器 (推薦)
1. 使用聲學校準器（如 94 dB @ 1kHz 或 114 dB @ 1kHz）
2. 將校準器對準麥克風
3. 記錄音訊並分析
4. 計算: `Calibration_Offset = 94 - L_relative_measured`

#### 方法 2: 與參考設備比較
1. 使用專業聲級計測量環境噪音
2. 同時使用待校準設備錄音
3. 比較兩者讀數差異

### 適用條件

| 條件 | 說明 |
|------|------|
| ✅ 線性響應 | 錄音系統在測量範圍內為線性 |
| ✅ 固定增益 | 錄音期間增益設定不變 |
| ✅ 頻率響應平坦 | 或已知頻率響應曲線 |
| ✅ 一致的錄音設備 | 同一麥克風、音效卡、設定 |

### 本系統使用

在本系統中，麥克風校準偏移套用到：
- Leq、Lmax、Lmin、L10、L90 等噪音指標
- FFT 頻譜圖
- Level vs Time 圖表
- 1/3 倍頻程分析
- Discrete Tone 檢測

---

## 2. Spectrogram SPL 偏移 (dB SPL 絕對模式)

### 學理基礎

**標準依據**: 功率譜密度 (PSD) 定義、Parseval 定理

Spectrogram 使用 `scipy.signal.spectrogram` 計算，返回的是**功率譜密度 (Power Spectral Density, PSD)**：

```python
Sxx = |STFT(x)|²
L_spec = 10 × log₁₀(Sxx + ε)  # 單位: dB (相對)
```

這個值是**無量綱的相對功率**，不是 dB SPL。

### 為什麼需要額外偏移

FFT 頻譜和 Spectrogram 雖然都是頻譜分析，但計算方式不同：

| 分析方法 | 計算公式 | 基準 |
|----------|----------|------|
| **FFT 頻譜** | `20 × log₁₀(|X(f)|)` | 振幅 |
| **Spectrogram** | `10 × log₁₀(Sxx)` | 功率譜密度 |

兩者的數值差異取決於：
1. **FFT 窗長 (n_fft)**: 影響頻率解析度
2. **正規化方法**: scipy 使用功率譜密度正規化
3. **窗函數能量**: 不同窗函數有不同的能量損失

### 公式推導

理論上，若要將 PSD 轉換為 dB SPL：

```
L_spl_spec = 10 × log₁₀(Sxx) + 10 × log₁₀(ENBW) + L_ref

其中:
- ENBW: 等效噪音頻寬 (Equivalent Noise Bandwidth)
- L_ref: 參考聲壓級偏移
```

對於 Hann 窗:
```
ENBW = 1.5 × (fs / n_fft)  # fs: 取樣率, n_fft: FFT 點數
```

### 簡化校準方法

由於完整的 PSD 到 dB SPL 轉換較複雜，本系統採用**經驗校準法**：

1. 使用已知音訊（如 1kHz 正弦波，Leq = 94 dB）
2. 觀察 Spectrogram 在 1kHz 處的顯示值（如 -15 dB）
3. 計算: `SPL_Offset = 94 - (-15) = 109 dB`

這個方法在以下條件下準確：
- 使用相同的 FFT 參數 (n_fft, hop_length, window)
- 音訊取樣率一致
- 比較的是相同頻率點

### 適用條件

| 條件 | 說明 |
|------|------|
| ✅ 固定 FFT 參數 | n_fft、hop_length 不變 |
| ✅ 相同窗函數 | 如統一使用 Hann 窗 |
| ✅ 參考音訊校準 | 使用已知 dB SPL 的音訊確定偏移 |
| ⚠️ 頻率相關性 | 偏移值在不同頻率可能略有差異 |

### 本系統使用

SPL 偏移僅套用到：
- Spectrogram (頻譜瀑布圖)
- 3D Waterfall 圖
- 音訊播放器中的 Spectrogram

**不套用到**：FFT 頻譜、Leq 等（這些已有麥克風校準偏移）

---

## 3. 兩個偏移值的關係

### 典型數值

| 偏移類型 | 典型範圍 | 影響因素 |
|----------|----------|----------|
| 麥克風校準偏移 | 0 ~ 30 dB | 麥克風靈敏度、音效卡增益 |
| SPL 偏移 (Spectrogram) | 90 ~ 130 dB | FFT 參數、正規化方法 |

### 為什麼數值差異大

麥克風校準偏移約 **+9 dB**，而 SPL 偏移約 **+110 dB**，差異約 100 dB。

這是因為：
1. **FFT 頻譜**使用的是**振幅** (amplitude)，已經接近 dB SPL
2. **Spectrogram**使用的是**功率譜密度**，是非常小的數值（約 10⁻¹⁰ 量級）

數學關係：
```
若 x = 10⁻⁵ (典型振幅值)

FFT 頻譜: 20 × log₁₀(10⁻⁵) = -100 dB
Spectrogram PSD: 10 × log₁₀(10⁻¹⁰) = -100 dB

但因為正規化方式不同，實際差異約 100 dB
```

---

## 4. 驗證方法

### 步驟 1: 準備校準音訊
使用 HEAD acoustics 或其他專業設備，生成已知 dB SPL 的音訊：
- 1kHz 正弦波，94 dB SPL

### 步驟 2: 確定麥克風校準偏移
1. 在本系統分析該音訊
2. 查看 Leq 讀數（例如 85 dB）
3. 計算: `Calibration_Offset = 94 - 85 = 9 dB`

### 步驟 3: 確定 SPL 偏移
1. 輸入麥克風校準偏移後，確認 Leq = 94 dB
2. 查看 Spectrogram 在 1kHz 處的值（例如 -16 dB）
3. 計算: `SPL_Offset = 94 - (-16) = 110 dB`

### 步驟 4: 驗證
使用其他已知音訊驗證校準是否正確。

---

## 5. 限制與注意事項

### ⚠️ 校準限制

1. **頻率依賴性**: 麥克風頻率響應不平坦時，單一偏移值無法完全補償
2. **動態範圍**: 極低或極高聲壓級時，校準可能不準確
3. **環境因素**: 溫度、濕度會影響麥克風靈敏度

### ⚠️ 適用場景

| 場景 | 建議 |
|------|------|
| 相對比較分析 | 不需要校準偏移 |
| 絕對聲壓級測量 | 需要校準偏移 |
| 與專業設備對比 | 需要校準偏移 |
| 趨勢分析 | 不需要校準偏移 |

---

## 6. 參考標準

- **IEC 61672-1:2013** - 聲級計標準
- **IEC 61260-1:2014** - 倍頻程和分數倍頻程濾波器
- **IEC 61094** - 麥克風校準
- **ECMA-74** - IT 設備噪音測量
- **ISO 3744** - 聲功率測定

---

## 總結

兩個校準偏移在學理上是**站得住腳的**，只要滿足以下條件：

### 麥克風校準偏移
✅ 使用校準器或參考設備確定  
✅ 錄音系統線性且增益固定  
✅ 適用於所有基於振幅的分析

### SPL 偏移 (Spectrogram)
✅ 使用已知音訊經驗確定  
✅ FFT 參數保持一致  
✅ 僅用於視覺顯示，不影響核心計算

**關鍵原則**: 校準偏移是**常數加法**，只改變數值的顯示基準，不影響相對關係和分析結論。
